# ------------------------------------------------------------
# EnclaWe 1.0   Rel 251212
# December 2025
# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
# Aldus Prinzimaker
# ------------------------------------------------------------
# File: docs/apache2.example.conf
# Example Apache2 configuration for production deployment
# ------------------------------------------------------------
#
# Required Apache modules:
#   sudo a2enmod proxy proxy_http proxy_wstunnel ssl headers rewrite
#
# Installation:
# 1. Copy this file to /etc/apache2/sites-available/enclawe.conf
# 2. Update ServerName, SSLCertificateFile, SSLCertificateKeyFile
# 3. Enable site: a2ensite enclawe
# 4. Test: apachectl configtest
# 5. Reload: systemctl reload apache2
# ------------------------------------------------------------

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName enclawe.example.com
    ServerAdmin webmaster@example.com

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]

    # Allow Let's Encrypt verification
    Alias /.well-known/acme-challenge/ /var/www/certbot/.well-known/acme-challenge/
    <Directory "/var/www/certbot/.well-known/acme-challenge/">
        AllowOverride None
        Options None
        Require all granted
    </Directory>
</VirtualHost>

# Main HTTPS server
<VirtualHost *:443>
    ServerName enclawe.example.com
    ServerAdmin webmaster@example.com

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/enclawe.example.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/enclawe.example.com/privkey.pem

    # SSL Security Settings
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # HSTS (optional, uncomment if desired)
    # Header always set Strict-Transport-Security "max-age=63072000"

    # Security Headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/enclawe_error.log
    CustomLog ${APACHE_LOG_DIR}/enclawe_access.log combined

    # Proxy settings
    ProxyPreserveHost On
    ProxyRequests Off

    # Enable rewrite engine for WebSocket upgrade
    RewriteEngine On

    # WebSocket proxy (must be before other proxy rules)
    # Upgrade connection for WebSocket
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/ws(.*)$ ws://127.0.0.1:3001/ws$1 [P,L]

    # WebSocket endpoint
    <Location /ws>
        ProxyPass ws://127.0.0.1:3001/ws
        ProxyPassReverse ws://127.0.0.1:3001/ws
    </Location>

    # API endpoints
    <Location /api/>
        ProxyPass http://127.0.0.1:3001/api/
        ProxyPassReverse http://127.0.0.1:3001/api/
    </Location>

    # Webhook endpoints
    <Location /webhook/>
        ProxyPass http://127.0.0.1:3001/webhook/
        ProxyPassReverse http://127.0.0.1:3001/webhook/

        # Pass Telegram webhook secret header
        RequestHeader set X-Telegram-Bot-Api-Secret-Token %{HTTP:X-Telegram-Bot-Api-Secret-Token}e
    </Location>

    # Health check endpoint
    <Location /health>
        ProxyPass http://127.0.0.1:3001/health
        ProxyPassReverse http://127.0.0.1:3001/health
    </Location>

    # Static client files (proxy to client service)
    <Location />
        ProxyPass http://127.0.0.1:3000/
        ProxyPassReverse http://127.0.0.1:3000/
    </Location>

    # Alternative: Serve static files directly (if client is local)
    # Uncomment below and comment out the Location / proxy above
    #
    # DocumentRoot /var/www/enclawe/client
    # <Directory /var/www/enclawe/client>
    #     AllowOverride None
    #     Require all granted
    #     Options -Indexes
    #
    #     # SPA fallback
    #     RewriteEngine On
    #     RewriteBase /
    #     RewriteCond %{REQUEST_FILENAME} !-f
    #     RewriteCond %{REQUEST_FILENAME} !-d
    #     RewriteRule . /index.html [L]
    # </Directory>

    # Deny access to hidden files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
</VirtualHost>
